<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DataCash - Gestor Financiero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary-blue: #007AFF; --primary-green: #34c759; --primary-red: #ff3b30;
            --background: #f8f9fa; --card-background: #ffffff; --text-primary: #1c1c1e;
            --text-secondary: #8e8e93; --border-color: #e5e5ea; --shadow-color: rgba(0,0,0,0.06);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-primary); padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        .auth-section { background: var(--card-background); border-radius: 16px; box-shadow: 0 6px 25px var(--shadow-color); padding: 40px; margin: 40px auto; max-width: 450px; display: none; flex-direction: column; gap: 20px; }
        .gestor-section { display: none; }
        h2 { text-align: center; color: var(--primary-blue); margin-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        .btn { padding: 12px 20px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; width: 100%; }
        .btn-blue { background: var(--primary-blue); color: white; }
        .btn-green { background: var(--primary-green); color: white; }
        .btn-red { background: var(--primary-red); color: white; }
        .link { text-align: center; margin-top: 15px; }
        .link a { color: var(--primary-blue); text-decoration: none; font-weight: 600; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .header h1 { font-size: 2rem; }
        .input-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .input-card { background: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); }
        .resumen-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; align-items: start; /* <-- ESTA LÍNEA ES LA SOLUCIÓN */ }
        .resumen-card { background: var(--card-background); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); }
        .resumen-card h3 { color: var(--text-secondary); font-size: 1rem; margin-bottom: 10px; }
        .resumen-card p { font-size: 1.8rem; font-weight: 700; }
        .detalles-list { list-style: none; padding-top: 15px; }
        .detalle-item { background: #fdfdfd; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid; }
        .detalle-item.ingreso { border-left-color: var(--primary-green); }
        .detalle-item.gasto { border-left-color: var(--primary-red); }
        .detalle-monto { font-weight: 600; }
        .detalle-acciones button { background: none; border: none; cursor: pointer; color: var(--primary-red); font-size: 1.2rem; }
        .chart-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .chart-container { background: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); position: relative; height: 350px; }
        @media (max-width: 768px) { .chart-section { grid-template-columns: 1fr; } }

        /* --- ESTILOS PARA LA SECCIÓN DE ADMINISTRADOR --- */
        .admin-section { padding: 20px; }
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .admin-users-section {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .admin-users-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        .admin-users-table table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .admin-users-table th, .admin-users-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-users-table th {
            background-color: var(--background);
            font-weight: 600;
        }
        .admin-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .admin-action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin: 0 4px;
            font-size: 0.9rem;
        }
        .admin-action-btn.view { background: var(--primary-blue); color: white; }
        .admin-action-btn.delete { background: var(--primary-red); color: white; }
        .user-stats-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        /* --- ESTILOS PARA LAS TARJETAS DESPLEGABLES --- */
        .collapsible-trigger {
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease;
        }
        .collapsible-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .collapsible-trigger .resumen-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-trigger .icon { transition: transform 0.3s ease; }
        .collapsible-trigger.active .icon { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow-y: auto; transition: max-height 0.4s ease-out; background: #f8f9fa; border-radius: 0 0 12px 12px; }
        #totalIngresos { color: var(--primary-green); }
        #totalGastos { color: var(--primary-red); }
    </style>
</head>
<body>
    <div class="container">
        <!-- SECCIÓN DE ADMINISTRADOR -->
        <div class="admin-section" id="adminSection" style="display: none;">
            <div class="header">
                <h1>Panel de Administración - DataCash</h1>
                <div>
                    <span id="adminNameDisplay" style="margin-right: 20px;"></span>
                    <button class="btn btn-red" onclick="cerrarSesion()">Cerrar Sesión</button>
                </div>
            </div>
            
            <!-- Panel de Estadísticas Generales -->
            <div class="admin-stats">
                <div class="resumen-card">
                    <h3>Usuarios Totales</h3>
                    <p id="totalUsuarios">0</p>
                </div>
                <div class="resumen-card">
                    <h3>Transacciones Totales</h3>
                    <p id="totalTransacciones">0</p>
                </div>
                <div class="resumen-card">
                    <h3>Movimiento Total</h3>
                    <p id="movimientoTotal">$0</p>
                </div>
            </div>

            <!-- Lista de Usuarios -->
            <div class="admin-users-section">
                <h2>Usuarios Registrados</h2>
                <div class="admin-users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Fecha Registro</th>
                                <th>Balance Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <!-- Los usuarios se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gráficos Administrativos -->
            <div class="admin-charts">
                <div class="chart-container">
                    <h3>Actividad de Usuarios</h3>
                    <canvas id="userActivityChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribución de Transacciones</h3>
                    <canvas id="transactionDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE AUTENTICACIÓN -->
        <div id="authContainer">
             <div class="auth-section" id="loginSection">
                <h2>Iniciar Sesión</h2>
                <div class="input-group"><label for="loginEmail">Correo</label><input type="email" id="loginEmail"></div>
                <div class="input-group"><label for="loginPassword">Contraseña</label><input type="password" id="loginPassword"></div>
                <button class="btn btn-blue" onclick="iniciarSesion()">Iniciar Sesión</button>
                <p class="link">¿No tienes cuenta? <a href="#" onclick="mostrarAuth('registro')">Regístrate</a></p>
            </div>
            <div class="auth-section" id="registroSection">
                <h2>Registro</h2>
                <div class="input-group"><label for="regNombre">Nombre</label><input type="text" id="regNombre"></div>
                <div class="input-group"><label for="regEmail">Correo</label><input type="email" id="regEmail"></div>
                <div class="input-group"><label for="regPassword">Contraseña</label><input type="password" id="regPassword"></div>
                <button class="btn btn-blue" onclick="registrarUsuario()">Registrarse</button>
                <p class="link">¿Ya tienes cuenta? <a href="#" onclick="mostrarAuth('login')">Inicia sesión</a></p>
            </div>
        </div>

        <!-- SECCIÓN PRINCIPAL DEL GESTOR -->
        <div class="gestor-section" id="gestorSection">
            <div class="header">
                <h1>DataCash</h1>
                <div>
                    <span id="userNameDisplay" style="margin-right: 20px;"></span>
                    <button class="btn btn-red" onclick="cerrarSesion()">Cerrar Sesión</button>
                </div>
            </div>
            
            <!-- Formularios para añadir transacciones -->
            <div class="input-section">
                <div class="input-card">
                    <h3><i class='bx bx-log-in-circle' style="color:var(--primary-green)"></i> Nuevo Ingreso</h3>
                    <div class="input-group"><label>Monto</label><input type="number" id="ingresoMonto"></div>
                    <div class="input-group"><label>Categoría</label><select id="categoriaIngreso"></select></div>
                    <div class="input-group"><label>Descripción</label><input type="text" id="descripcionIngreso"></div>
                    <div class="input-group"><label>Fecha</label><input type="date" id="fechaIngreso"></div>
                    <button class="btn btn-green" onclick="agregarTransaccion('ingreso')">Añadir Ingreso</button>
                </div>
                <div class="input-card">
                    <h3><i class='bx bx-log-out-circle' style="color:var(--primary-red)"></i> Nuevo Gasto</h3>
                    <div class="input-group"><label>Monto</label><input type="number" id="gastoMonto"></div>
                    <div class="input-group"><label>Categoría</label><select id="categoriaGasto"></select></div>
                    <div class="input-group"><label>Descripción</label><input type="text" id="descripcionGasto"></div>
                    <div class="input-group"><label>Fecha</label><input type="date" id="fechaGasto"></div>
                    <button class="btn btn-red" onclick="agregarTransaccion('gasto')">Añadir Gasto</button>
                </div>
            </div>

            <!-- ESTRUCTURA DE RESUMEN DESPLEGABLE -->
            <div class="resumen-section">
                <!-- Tarjeta de Ingresos Desplegable -->
                <div>
                    <div class="resumen-card collapsible-trigger" id="ingresos-trigger">
                        <div class="resumen-card-header">
                            <h3>Ingresos del Mes</h3>
                            <i class='bx bx-chevron-down icon'></i>
                        </div>
                        <p id="totalIngresos">$0</p>
                    </div>
                    <div class="collapsible-content">
                        <ul class="detalles-list" id="listaIngresos"></ul>
                    </div>
                </div>

                <!-- Tarjeta de Gastos Desplegable -->
                <div>
                    <div class="resumen-card collapsible-trigger" id="gastos-trigger">
                        <div class="resumen-card-header">
                            <h3>Gastos del Mes</h3>
                            <i class='bx bx-chevron-down icon'></i>
                        </div>
                        <p id="totalGastos">$0</p>
                    </div>
                    <div class="collapsible-content">
                        <ul class="detalles-list" id="listaGastos"></ul>
                    </div>
                </div>
                
                <!-- Tarjeta de Balance (no es desplegable) -->
                <div class="resumen-card" style="text-align: center;">
                    <h3>Balance</h3>
                    <p id="balanceMes">$0</p>
                </div>
            </div>

            <!-- SECCIÓN DE GRÁFICOS -->
            <div class="chart-section">
                <div class="chart-container">
                    <h3>Ingresos por Categoría</h3>
                    <canvas id="ingresosChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Gastos por Categoría</h3>
                    <canvas id="gastosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let currentUser = null;
        let currentMesId = null;
        let ingresosChartInstance = null;
        let gastosChartInstance = null;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount || 0);
        }

        // --- MANEJO DE VISTAS ---
        function mostrarAuth(vista) {
            document.getElementById('loginSection').style.display = (vista === 'login') ? 'flex' : 'none';
            document.getElementById('registroSection').style.display = (vista === 'registro') ? 'flex' : 'none';
        }

        function toggleVistaPrincipal(mostrarGestor) {
            document.getElementById('authContainer').style.display = mostrarGestor ? 'none' : 'block';
            document.getElementById('gestorSection').style.display = (mostrarGestor && currentUser?.rol !== 'ADMIN') ? 'block' : 'none';
            document.getElementById('adminSection').style.display = (mostrarGestor && currentUser?.rol === 'ADMIN') ? 'block' : 'none';
        }

        // --- LÓGICA DE LA APLICACIÓN ---
        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(API_BASE_URL + endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    alert(`Error: ${errorData.message}`); return null;
                }
                if (response.status === 204 || response.headers.get('Content-Length') === '0') return { success: true };
                return await response.json();
            } catch (error) {
                alert('No se pudo conectar con el servidor.'); return null;
            }
        }

        async function registrarUsuario() {
            const data = {
                nombre: document.getElementById('regNombre').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
            };
            if (!data.nombre || !data.email || !data.password) return alert('Todos los campos son obligatorios.');
            
            const result = await fetchAPI('/auth/registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (result) {
                alert('¡Usuario registrado! Ahora inicia sesión.');
                mostrarAuth('login');
            }
        }

        async function iniciarSesion() {
            const data = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            const result = await fetchAPI('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (result) {
                currentUser = { 
                    id: result.usuarioId, 
                    nombre: result.nombreUsuario,
                    rol: result.rol 
                };
                currentMesId = result.mesId;
                localStorage.setItem('session', JSON.stringify({ currentUser, currentMesId }));
                
                if (currentUser.rol === 'ADMIN') {
                    await inicializarPanelAdmin();
                } else {
                    await inicializarGestor();
                }
            }
        }

        // --- FUNCIONES DEL PANEL DE ADMINISTRADOR ---
        async function inicializarPanelAdmin() {
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('gestorSection').style.display = 'none';
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('adminNameDisplay').textContent = `Administrador: ${currentUser.nombre}`;
            
            await Promise.all([
                cargarEstadisticasGenerales(),
                cargarListaUsuarios(),
                cargarGraficosAdmin()
            ]);
        }

        async function cargarEstadisticasGenerales() {
            const stats = await fetchAPI('/admin/estadisticas');
            if (stats) {
                document.getElementById('totalUsuarios').textContent = stats.totalUsuarios;
                document.getElementById('totalTransacciones').textContent = stats.totalTransacciones;
                document.getElementById('movimientoTotal').textContent = formatCurrency(stats.movimientoTotal);
            }
        }

        async function cargarListaUsuarios() {
            const usuarios = await fetchAPI('/admin/usuarios');
            if (usuarios) {
                const tbody = document.getElementById('usersList');
                tbody.innerHTML = usuarios.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.nombre}</td>
                        <td>${user.email}</td>
                        <td>${new Date(user.fechaRegistro).toLocaleDateString()}</td>
                        <td>${formatCurrency(user.balanceTotal)}</td>
                        <td>
                            <button class="admin-action-btn view" onclick="verDetallesUsuario(${user.id})">
                                Ver Detalles
                            </button>
                            <button class="admin-action-btn delete" onclick="eliminarUsuario(${user.id})">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function cargarGraficosAdmin() {
            // Gráfico de Actividad de Usuarios
            const actividadData = await fetchAPI('/admin/actividad-usuarios');
            if (actividadData) {
                new Chart(document.getElementById('userActivityChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: actividadData.fechas,
                        datasets: [{
                            label: 'Transacciones',
                            data: actividadData.transacciones,
                            borderColor: '#007AFF',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // Gráfico de Distribución de Transacciones
            const distribucionData = await fetchAPI('/admin/distribucion-transacciones');
            if (distribucionData) {
                new Chart(document.getElementById('transactionDistributionChart').getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Ingresos', 'Gastos'],
                        datasets: [{
                            data: [distribucionData.ingresos, distribucionData.gastos],
                            backgroundColor: ['#34c759', '#ff3b30']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        async function verDetallesUsuario(userId) {
            const detalles = await fetchAPI(`/admin/usuario/${userId}/detalles`);
            if (detalles) {
                const modal = document.createElement('div');
                modal.className = 'user-stats-modal';
                modal.innerHTML = `
                    <h2>${detalles.nombre}</h2>
                    <div class="user-stats-content">
                        <div class="stat-item">
                            <h3>Balance Total</h3>
                            <p>${formatCurrency(detalles.balanceTotal)}</p>
                        </div>
                        <div class="stat-item">
                            <h3>Total Ingresos</h3>
                            <p>${formatCurrency(detalles.totalIngresos)}</p>
                        </div>
                        <div class="stat-item">
                            <h3>Total Gastos</h3>
                            <p>${formatCurrency(detalles.totalGastos)}</p>
                        </div>
                        <div class="stat-item">
                            <h3>Categorías Más Usadas</h3>
                            <ul>
                                ${detalles.categoriasPrincipales.map(cat => 
                                    `<li>${cat.nombre}: ${formatCurrency(cat.total)}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <button class="btn btn-blue" onclick="this.closest('.user-stats-modal').remove();
                            document.querySelector('.modal-backdrop').remove();">
                            Cerrar
                        </button>
                    </div>
                `;
                
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                backdrop.style.display = 'block';
                
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                modal.style.display = 'block';
            }
        }

        async function eliminarUsuario(userId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const result = await fetchAPI(`/admin/usuario/${userId}`, {
                method: 'DELETE'
            });
            
            if (result) {
                await cargarListaUsuarios();
                await cargarEstadisticasGenerales();
            }
        }

        function cerrarSesion() {
            localStorage.removeItem('session');
            if (ingresosChartInstance) ingresosChartInstance.destroy();
            if (gastosChartInstance) gastosChartInstance.destroy();
            toggleVistaPrincipal(false);
            mostrarAuth('login');
        }

        async function inicializarGestor() {
            toggleVistaPrincipal(true);
            document.getElementById('userNameDisplay').textContent = `Usuario: ${currentUser.nombre}`;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = today;
            document.getElementById('fechaGasto').value = today;
            await cargarCategorias();
            await cargarDatosDelMes();
        }

        async function cargarCategorias() {
            const [ingresos, gastos] = await Promise.all([
                fetchAPI('/categorias?tipo=ingreso'),
                fetchAPI('/categorias?tipo=gasto')
            ]);
            poblarDropdown('categoriaIngreso', ingresos || []);
            poblarDropdown('categoriaGasto', gastos || []);
        }

        function poblarDropdown(elementId, categorias) {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="">Seleccione...</option>';
            categorias.forEach(cat => select.innerHTML += `<option value="${cat.id}">${cat.nombreCategoria}</option>`);
            select.innerHTML += '<option value="-1">Otro</option>';
        }

        async function cargarDatosDelMes() {
            if (!currentMesId) return;
            const [ingresos, gastos] = await Promise.all([
                fetchAPI(`/ingresos?mesId=${currentMesId}`),
                fetchAPI(`/gastos?mesId=${currentMesId}`)
            ]);
            actualizarUI(ingresos || [], gastos || []);
        }

        function actualizarUI(ingresos, gastos) {
            const totalIngresos = ingresos.reduce((sum, item) => sum + item.cantidad, 0);
            const totalGastos = gastos.reduce((sum, item) => sum + item.cantidad, 0);
            document.getElementById('totalIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('totalGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('balanceMes').textContent = formatCurrency(totalIngresos - totalGastos);

            const renderizarLista = (elementId, transacciones, tipo) => {
                const listaEl = document.getElementById(elementId);
                const container = listaEl.closest('.collapsible-content');

                if (transacciones.length === 0) {
                    listaEl.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary);">No hay transacciones.</p>';
                } else {
                    listaEl.innerHTML = transacciones
                        .sort((a, b) => new Date(b.fechaTransaccion) - new Date(a.fechaTransaccion))
                        .map(item => `
                        <li class="detalle-item ${tipo}">
                            <div>
                                <div style="font-weight: 600;">${item.descripcion}</div>
                                <div style="font-size: 0.8em; color: var(--text-secondary);">${item.fechaTransaccion} - ${item.categoria ? item.categoria.nombreCategoria : 'Otro'}</div>
                            </div>
                            <div class="detalle-monto">${formatCurrency(item.cantidad)}</div>
                            <div class="detalle-acciones">
                                <button onclick="eliminarTransaccion(${item.id}, '${tipo}')"><i class='bx bxs-trash'></i></button>
                            </div>
                        </li>`).join('');
                }
                 // Re-ajustar la altura del desplegable si está abierto
                if (container && container.style.maxHeight) {
                    container.style.maxHeight = container.scrollHeight + "px";
                }
            };

            renderizarLista('listaIngresos', ingresos, 'ingreso');
            renderizarLista('listaGastos', gastos, 'gasto');
            actualizarGraficos(ingresos, gastos);
        }

        async function agregarTransaccion(tipo) {
            const data = {
                mesId: currentMesId,
                cantidad: parseFloat(document.getElementById(`${tipo}Monto`).value),
                categoriaId: parseInt(document.getElementById(`categoria${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value) || null,
                descripcion: document.getElementById(`descripcion${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value,
                fechaTransaccion: document.getElementById(`fecha${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value,
            };
            if (!data.cantidad || !data.descripcion || !data.fechaTransaccion) return alert('Monto, descripción y fecha son obligatorios.');

            const endpoint = (tipo === 'ingreso') ? '/ingresos' : '/gastos';
            const result = await fetchAPI(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (result) {
                cargarDatosDelMes();
                document.getElementById(`${tipo}Monto`).value = '';
                document.getElementById(`descripcion${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = '';
            }
        }

        async function eliminarTransaccion(id, tipo) {
            if (!confirm('¿Seguro que quieres eliminar esta transacción?')) return;
            const endpoint = (tipo === 'ingreso') ? `/ingresos/${id}` : `/gastos/${id}`;
            const result = await fetchAPI(endpoint, { method: 'DELETE' });
            if (result) {
                cargarDatosDelMes();
            }
        }

        function actualizarGraficos(ingresos, gastos) {
            if (ingresosChartInstance) ingresosChartInstance.destroy();
            if (gastosChartInstance) gastosChartInstance.destroy();
            const processData = (data, defaultCategory) => data.reduce((acc, item) => {
                const categoria = item.categoria ? item.categoria.nombreCategoria : defaultCategory;
                acc[categoria] = (acc[categoria] || 0) + item.cantidad;
                return acc;
            }, {});
            const createChart = (ctx, data, colors) => {
                if (!ctx) return null;
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } }
                });
            };
            ingresosChartInstance = createChart(document.getElementById('ingresosChart')?.getContext('2d'), processData(ingresos, 'Otro Ingreso'), ['#34c759', '#a2d2ff', '#bde0fe']);
            gastosChartInstance = createChart(document.getElementById('gastosChart')?.getContext('2d'), processData(gastos, 'Otro Gasto'), ['#ff3b30', '#ffcc00', '#ff9500']);
        }

        // --- INICIO DE LA APP ---
        document.addEventListener('DOMContentLoaded', () => {
            const sessionData = localStorage.getItem('session');
            if (sessionData) {
                const { currentUser: savedUser, currentMesId: savedMesId } = JSON.parse(sessionData);
                if (savedUser && savedMesId) {
                    currentUser = savedUser;
                    currentMesId = savedMesId;
                    inicializarGestor();
                } else {
                    toggleVistaPrincipal(false);
                    mostrarAuth('login');
                }
            } else {
                toggleVistaPrincipal(false);
                mostrarAuth('login');
            }

            // Lógica para todos los desplegables de las tarjetas de resumen
            document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                trigger.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.parentElement.querySelector('.collapsible-content');
                    if (content) {
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>

